<?xml version="1.0"?>
<project name="apigee-drupal-project" default="apigee-drupal" description="Apigee Drupal Build">
	
	<!--
	
	Two types of builds: internal and external build. Internal builds are those who have access to the apigee/drupal-settings repo.
	External builds are those who do not. Default is an external build. Internal builds will have ${build.type} = internal
	in their Jenkins default properties.
	
	From the command line: phing apigee-drupal -Dbuild.type=internal
	
	-->
	
	<property name="build.type" value="external" override="false" />
	



	<target name='init'>
		<echo>-------------------------------------------------</echo>
		<echo> => cloning latest drupal settings </echo>
		<echo>-------------------------------------------------</echo>
		<delete dir="drupal-settings" quiet="true" />
		<delete dir="tasks" quiet="true" />
		<mkdir dir="tasks" />
		<gitclone repository="http://git.drupal.org/project/phingdrushtask.git" targetPath="tasks/drush" />
		<gitbranch repository="tasks/drush" branchname="7.x-1.x" />
		<gitclone repository="git@github.com:AntonStoeckl/Phing-Additions.git" targetPath="tasks/additions" />
		<if>
			<equals arg1="${build.type}" arg2="internal" />
			<then>
				<gitclone repository="git@github.com:apigee/drupal-settings" targetPath="drupal-settings" />
			</then>
		</if>
		
	</target>
	<target name="apigee-drupal">
		<echo>-------------------------------------------------</echo>
		<echo> +++++ Running Phing/Drush build </echo>
		<echo>-------------------------------------------------</echo>
		<phingcall target="init" />
		<includepath classpath="tasks" />
		<taskdef name="drush" classname="drush.DrushTask" />
		<drush command="cc">
			<param>drush</param>
		</drush>
	    <drush command="make" assume="yes">
			<option name="prepare-install" />
			<option name="working-copy" />
			<option name="no-gitinfofile" />
			<!-- option name="no-cache" /   -->
			<param>apigee.make</param>
			<param>webapp</param>
		</drush>
	</target>
	<target name="dc-local-build">
		<drush command="cc">
			<param>drush</param>
		</drush>
		<drush alias="@dc-local" assume="yes" command="updatedb" /> 
		<drush alias="@dc-local" assume="yes" command="cc">
			<param>all</param> 
		</drush>
	</target>
	<target name="dc-dev-build">
		<if>
			<equals arg1="${build.type}" arg2="internal" />
			<then>
				<copy todir="webapp/sites" >
				  <fileset dir="drupal-settings/sites">
				    <include name="**/**" />
				  </fileset>
				</copy>
			</then>
		</if>
		<property prefix="dc.dev" file="drupal-settings/properties/dc.dev.properties" />
		<drush command="cc">
			<param>drush</param>
		</drush>
		<phingcall target="fix-perms">
			<property name="root" value="${dc.dev.root}" />
			<property name="exec" value="${dc.dev.exec}" />
			<property name="name" value="${dc.dev.name}" />
		</phingcall>
		<move file="${dc.dev.root}" todir="/tmp/dc-build-scraps-${BUILD_ID}" />
		<move file="${WORKSPACE}/webapp" todir="${dc.dev.container}" />
		<drush alias="@dc-dev" assume="yes" command="updatedb" /> 
		<drush alias="@dc-dev" assume="yes" command="cc">
			<param>all</param> 
		</drush>
		<phingcall target="fix-perms">
			<property name="root" value="${dc.dev.root}" />
			<property name="exec" value="${dc.dev.exec}" />
			<property name="name" value="${dc.dev.name}" />
		</phingcall>
		<delete dir="${dc.dev.root}/modules/php" />
	</target>
	<target name="docs-dev-build">
		<if>
			<equals arg1="${build.type}" arg2="internal" />
			<then>
				<copy todir="webapp/sites" >
				  <fileset dir="drupal-settings/sites">
				    <include name="docs-*/**/**" />
				  </fileset>
				</copy>
			</then>
		</if>
		<property prefix="docs.dev" file="drupal-settings/properties/docs.dev.properties" />
		<property prefix="docs.dit" file="drupal-settings/properties/docs.dit.properties" />
		<echo> ===> Backup files folder on ${docs.dit.name} </echo>
		<phingcall task="backup-files-folder">
			<property name="exec" value="${docs.dit.exec}" />
			<property name="root" value="${docs.dit.root}" />
			<property name="site_name" value="${docs.dit.name}" />
			<property name="planet_storage" value="${docs.dit.name}" />
		</phingcall>
		<echo> ===> Fix permissions on current dev build so it can be moved without permissions errors </echo>
		<phingcall target="fix-perms">
			<property name="root" value="${docs.dev.root}" />
			<property name="exec" value="${docs.dev.exec}" />
			<property name="name" value="${docs.dev.name}" />
		</phingcall>
		<echo> ===> Moving files </echo>
		<move file="${docs.dev.root}" todir="/tmp/docs-build-scraps-${BUILD_ID}" includeemptydirs="true" />
		<move file="${WORKSPACE}/webapp" todir="${docs.dev.container}" includeemptydirs="true" />
		<echo> ===> Fix permissions on new build </echo>
		<phingcall target="fix-perms">
			<property name="root" value="${docs.dev.root}" />
			<property name="exec" value="${docs.dev.exec}" />
			<property name="name" value="${docs.dev.name}" />
		</phingcall>
		<echo> ===> Copy sites/docs-dit/files down from dit storage </echo>
		<phingcall task="restore-files-folder">
			<property name="exec" value="${docs.dev.exec}" />
			<property name="root" value="${docs.dev.root}" />
			<property name="from_site_name" value="${docs.dit.name}" />
			<property name="to_site_name" value="${docs.dit.name}" />
			<property name="planet_storage" value="${docs.dit.name}" />
		</phingcall>
		<echo> ===> Drush Updatedb </echo>
		<drush alias="@docs-dev" command="updatedb" assume="yes" />
		<echo> ===> Clearing Cache </echo>
		<drush alias="@docs-dev" command="cc" assume="yes">
			<param>all</param>
		</drush>
		<symlink target="${docs.dev.root}/sites/docs-dit/files" 
			link="${docs.dev.root}/sites/docs-dev/files" />
		<echo> ===> Fix Permissions one last time for good measure...</echo>
		<phingcall target="fix-perms">
			<property name="root" value="${docs.dev.root}" />
			<property name="exec" value="${docs.dev.exec}" />
			<property name="name" value="${docs.dev.name}" />
		</phingcall>
	</target>
	<target name='copy-drush'>
		<copy todir="${user.home}/.drush" overwrite="true" >
			<fileset dir="drupal-settings/drush">
				<include name="*.aliases.drushrc.php" />
			</fileset>
		</copy>
	</target>
	<target name="mktg-dev-build">
		<property prefix="mktg.dev" file="properties/mktg.dev.properties" />
		<copy todir="webapp/sites" >
		  <fileset dir="drupal-settings/sites">
		    <include name="mktg-*/**/**" />
		  </fileset>
		</copy>
		<phingcall target="fix-perms">
			<property name="root" value="${mktg.dev.root}" />
			<property name="exec" value="${mktg.dev.exec}" />
			<property name="name" value="${mktg.dev.name}" />
		</phingcall>
		<phingcall task="backup-files-folder">
			<property name="root" value="${mktg.dev.root}" />
			<property name="exec" value="${mktg.dev.exec}" />
			<property name="from_site_name" value="${mktg.dev.name}" />			
			<property name="to_site_name" value="${mktg.dev.name}" />
			<property name="planet_storage" value="devconnect-dit" />
		</phingcall>
		<drush command="cc">
			<param>drush</param>
		</drush>
		<move file="${mktg.dev.root}" todir="/tmp/mktg-build-scraps-${BUILD_ID}" />
		<move file="${WORKSPACE}/webapp" todir="${mktg.dev.container}" />
		<phingcall task="restore-files-folder">
			<property name="root" value="${mktg.dev.root}" />
			<property name="exec" value="${mktg.dev.exec}" />
			<property name="from_site_name" value="${mktg.dev.name}" />			
			<property name="to_site_name" value="${mktg.dev.name}" />
			<property name="planet_storage" value="devconnect-dit" />
		</phingcall>
		<mkdir dir="${mktg.dev.root}/sites/mktg-dev/tmp" />
		<mkdir dir="${mktg.dev.root}/sites/mktg-dev/private" />
		<drush alias="@mktg-dev" assume="yes" command="updatedb" /> 
		<drush alias="@mktg-dev" assume="yes" command="cc">
			<param>all</param> 
		</drush>
		<phingcall target="fix-perms">
			<property name="root" value="${mktg.dev.root}" />
			<property name="exec" value="${mktg.dev.exec}" />
			<property name="name" value="${mktg.dev.name}" />
		</phingcall>
	</target>
	<target name="blog-dev-build">
		<property prefix="blog.dev" file="properties/blog.dev.properties" />
		<copy todir="webapp/sites" >
		  <fileset dir="drupal-settings/sites">
		    <include name="blog-*/**/**" />
		  </fileset>
		</copy>
		<phingcall target="fix-perms">
			<property name="root" value="${blog.dev.root}" />
			<property name="exec" value="${blog.dev.exec}" />
			<property name="name" value="${blog.dev.name}" />
		</phingcall>
		<phingcall task="backup-files-folder">
			<property name="root" value="${blog.dev.root}" />
			<property name="exec" value="${blog.dev.exec}" />
			<property name="from_site_name" value="${blog.dev.name}" />			
			<property name="to_site_name" value="${blog.dev.name}" />
			<property name="planet_storage" value="devconnect-dit" />
		</phingcall>
		<drush command="cc">
			<param>drush</param>
		</drush>
		<phingcall target="fix-perms">
			<property name="root" value="${blog.dev.root}" />
			<property name="exec" value="${blog.dev.exec}" />
			<property name="name" value="${blog.dev.name}" />
		</phingcall>
		<move file="${blog.dev.root}" todir="/tmp/blog-build-scraps-${BUILD_ID}" />
		<move file="${WORKSPACE}/webapp" todir="${blog.dev.container}" />
		<phingcall task="restore-files-folder">
			<property name="root" value="${blog.dev.root}" />
			<property name="exec" value="${blog.dev.exec}" />
			<property name="from_site_name" value="${blog.dev.name}" />			
			<property name="to_site_name" value="${blog.dev.name}" />
			<property name="planet_storage" value="devconnect-dit" />
		</phingcall>
		<mkdir dir="${mktg.dev.root}/sites/mktg-dev/tmp" />
		<mkdir dir="${mktg.dev.root}/sites/mktg-dev/private" />
		<drush alias="@blog-dev" assume="yes" command="updatedb" /> 
		<drush alias="@blog-dev" assume="yes" command="cc">
			<param>all</param> 
		</drush>
		<phingcall target="fix-perms">
			<property name="root" value="${blog.dev.root}" />
			<property name="exec" value="${blog.dev.exec}" />
			<property name="name" value="${blog.dev.name}" />
		</phingcall>
	</target>
	<target name="fix-perms">
		<echo> ===> Fixing Permissions on ${name} </echo>
		<if>
			<equals arg1="${exec}" arg2="local" />
			<then>
				<exec command="sudo chmod -R 777 ${root}"  logoutput="true"  />
				<exec command="sudo chown -R apache.apache ${root}"  logoutput="true" />
			</then>
			<else>
				<exec command="${exec} sudo chmod -R 777 ${root}"  logoutput="true"  />
				<exec command="${exec} sudo chown -R apache.apache ${root}"  logoutput="true" />
			</else>
		</if>
	</target>
	<target name="backup-files-folder">
		<if>
			<equals arg1="${exec}" arg2="local" />
			<then>
				<echo> ===> backing up local files in ${root}/sites/${site_name}/files to ${planet_storage}...</echo>
				<exec 
					command="/usr/bin/s3cmd put --recursive --acl-public ${root}/sites/${site_name}/files s3://${planet_storage}"
					logoutput="true" />
			</then>
			<else>
				<echo> ===> backing up remote files in ${root}/sites/${site_name}/files to ${planet_storage}...</echo>
				<exec 
					command="${exec} /usr/bin/s3cmd put --recursive --acl-public ${root}/sites/${site_name}/files s3://${planet_storage}"
					logoutput="true" />
			</else>
		</if>
	</target>
	<target name="restore-files-folder">
		<if>
			<equals arg1="${exec}" arg2="local" />
			<then>
				<echo> ===> restoring local files to ${root}/sites/${site_name}/files...</echo>
				<exec 
					command="/usr/bin/s3cmd get s3://${planet_storage}/${from_site_name}/files ${root}/sites/${to_site_name}"
					logoutput="true" />
			</then>
			<else>
				<echo> ===> restoring remote files in ${root}/sites/${site_name}/files to ${planet_storage}...</echo>
				<exec 
					command="${exec} /usr/bin/s3cmd get s3://${planet_storage}/${from_site_name}/files ${root}/sites/${to_site_name}"
					logoutput="true" />
			</else>
		</if>
	</target>
</project>
